# Установка и настройка PostgreSQL в контейнере Docker
1. Сделать в GCE инстанс с Ubuntu 20.04

Navigation menu/compute engine/vm instances/create instance/.../create

2. Поставить на нем Docker Engine
```
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
rm get-docker.sh
sudo usermod -aG docker $USER
```
 
3. Сделать каталог /var/lib/postgres
```
sudo mkdir /var/lib/postgres
```

4. Развернуть контейнер с PostgreSQL 13 смонтировав в него /var/lib/postgres
4.1 Создаем docker-сеть pg-net: 
```
sudo docker network create pg-net
```
4.2 Подключение сети к контейнеру сервера Postgres, первый запуск через скачивание образа из docker HUB:
```
sudo docker run --name pg-docker --network pg-net -e POSTGRES_PASSWORD=12345 -d -p 5432:5432 -v /var/lib/postgres:/var/lib/postgresql/data postgres:13
```

5. Запускаем отдельный контейнер с клиентом в общей сети с БД:
```
sudo docker run -it --rm --network pg-net --name pg-client postgres:13 psql -h pg-docker -U postgres
```
6. Проверяем, что имеем:
```
sudo docker container ls
```
Ответ:

CONTAINER ID   IMAGE         COMMAND                  CREATED        STATUS        PORTS                                       NAMES

790f906e3ffd   postgres:13   "docker-entrypoint.s…"   24 hours ago   Up 24 hours   0.0.0.0:5432->5432/tcp, :::5432->5432/tcp   pg-docker



6. Подключится из контейнера с клиентом к контейнеру с сервером и сделать таблицу с парой строк:
```
CREATE DATABASE testdb;
create table test1 (
id BIGSERIAL, c1 VARCHAR(200), c2 VARCHAR(200), c3 VARCHAR(200)
);
INSERT INTO test1 (c1, c2, c3) values ('red', '1', '111');
INSERT INTO test1 (c1, c2, c3) values ('blue', '2', '222');
INSERT INTO test1 (c1, c2, c3) values ('green', '3', '333');
INSERT INTO test1 (c1, c2, c3) values ('black', '4', '444');
select * from test1;
```
Ответ: (4 rows)

id|c1|c2| c3|
:----|:--------:|:--------:|:-----:
1  |red    | 1 | 111
2|  blue   | 2 | 222
3 |green  | 3 | 333
4 |black  | 4 | 444


7. Подключится к контейнеру с сервером с ноутбука/компьютера извне инстансов GCP
```
psql -p 5432 -U postgres -h 34.77.202.96 -d postgres -W

sudo docker ps -a
```
Ответ:

CONTAINER ID   IMAGE         COMMAND                  CREATED          STATUS          PORTS                                       NAMES

e210f0665732   postgres:13   "docker-entrypoint.s…"   16 seconds ago   Up 15 seconds   5432/tcp                                    pg-client

790f906e3ffd   postgres:13   "docker-entrypoint.s…"   24 hours ago     Up 24 hours     0.0.0.0:5432->5432/tcp, :::5432->5432/tcp   pg-docker



8. Удалить контейнер с сервером

9. Создать его заново

10. Подключится снова из контейнера с клиентом к контейнеру с сервером

11. Проверить, что данные остались на месте

