# Практика применения репликаций в PostgreSQL.  
###### Desc: Postgresql 12. ВМ1По умолчанию #listen_addresses = 'localhost', поэтому, пренебрегая безопасностью активируем и правим на '*' :
```
vim /etc/postgresql/12/main/postgresql.conf
```


###### На ВМ1: Создание структуры = logical
```
ALTER SYSTEM SET wal_level = logical;
sudo pg_ctlcluster 12 main restart
show wal_level;
```
Ответ: wal_level logical
```
create database otus;
\c otus;
```
###### Создание таблиц test-заполненную, test2-пустую:
```
create table test(id int);
insert into test values (1), (2), (3);
create table test2(id int);
select * from test;
```
###### Ответ:

id|
:----:
1  
2  
3  
###### На ВМ2: Создание структуры = logical
```
ALTER SYSTEM SET wal_level = logical;
sudo pg_ctlcluster 12 main restart
show wal_level;
```
Ответ: wal_level logical
```
create database otus;
\c otus;
```
###### Создание таблиц test-пустую, test2-заполненную:
```
create table test(id int);
create table test2(id int);
insert into test2 values (10), (20), (30);
select * from test2;
```
###### Ответ:

id|
:----:
10  
20  
30  
###### На ВМ3: Создание таблиц без данных: test-пустую, test2-пустую:
```
create database otus;
\c otus;
create table test(id int);
create table test2(id int);
```
###### На ВМ1 создаем публикацию, предварительно ее проверив:
```
\dRp+
```
###### Ответ: Никакие публикации не найдены.
```
CREATE PUBLICATION test_pub FOR TABLE test;
```
Просмотр созданной публикации:
```
\dRp+
```
 Владелец | Все таблицы | Добавления | Изменения | Удаления | Опустошения
 :----|:--------|:--------|:--------|:--------|:--------:
postgres | f    | t       | t       | t       | t       |

Таблицы:   "public.test"
    
###### На ВМ2 создаем публикацию:
```
CREATE PUBLICATION test2_pub FOR TABLE test2;
```
###### Просмотр созданной публикации
```
\dRp+
```
 Владелец | Все таблицы | Добавления | Изменения | Удаления | Опустошения
 :----|:--------|:--------|:--------|:--------|:--------:
postgres | f    | t       | t       | t       | t       |

Таблицы:   "public.test2"
###### На ВМ1 создание подписки с переносом начальных данных с ВМ2:

```
CREATE SUBSCRIPTION test2_sub 
CONNECTION 'host=192.168.0.34 port=5432 user=postgres password=12345 dbname=otus' 
PUBLICATION test2_pub WITH (copy_data = true);
```
###### Просмотр подписки:
\dRs
###### Просмотр состояния подписки:
SELECT * FROM pg_stat_subscription \gx  



    

















