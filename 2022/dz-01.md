# Работа с уровнями изоляции транзакции.
##### 0. Первая сессия: установка postgresql-14. Тестовая база OTUS:
##### 1. Вторая сессия: выключить дефолтный auto commit:
```
\echo :AUTOCOMMIT
```
Ответ: on
```
\set AUTOCOMMIT OFF
\echo :AUTOCOMMIT
```
Ответ: off.  Что с уровнем изоляции? :
```
SHOW transaction_isolation;
```
Ответ: read committed (1 строка)
##### 3. Первая сессия (писатель):
```
SELECT current_database();
\c otus
CREATE TABLE persons (id serial, first_name text, second_name text);
INSERT INTO persons (first_name, second_name) values ('ivan', 'ivanov'); 
INSERT INTO persons (first_name, second_name) values ('petr', 'petrov'); 
commit;
SELECT * FROM persons;
```
id|first_name|second_name|
:----|:--------:|-----:
1  |ivan    |ivanov |
2|  petr   |petrov | 

##### 4. Вторая сессия (читатель): все тоже самое:
```
SELECT * FROM persons;
```
id|first_name|second_name|
:----|:--------:|-----:
1  |ivan    |ivanov |
2|  petr   |petrov | 
##### 5. Новая транзакция: Первая сессия:
```
insert into persons (first_name, second_name) values('sergey', 'sergeev');
SELECT * FROM persons;
```
id|first_name|second_name|
:----|:--------:|-----:
1  |ivan    |ivanov |
2|  petr   |petrov | 
3|  sergey   |sergeev | 

##### 6.  Вторая сессия:
```
SELECT * FROM persons;
```
id|first_name|second_name|
:----|:--------:|-----:
1  |ivan    |ivanov |
2|  petr   |petrov | 

###### Ты видишь суслика? Нет? И я не вижу, а он есть. (фильм ДМБ)
##### 7. Первая сессия: легким движением руки брюки превращаются:
```
commit;
```
##### 8. Вторая сессия: а вот и он, суслик:
```
select * from persons;
```
id|first_name|second_name|
:----|:--------:|-----:
1  |ivan    |ivanov |
2|  petr   |petrov | 
3|  sergey   |sergeev |

###### Теперь появилась новая запись, т.к. ручной ввод commit завершил транзакцию в первой сессии.
##### 9. Теперь повысим уровень до повторяемого чтения, где set transaction isolation level = repeatable read. Первая сессия или/или:
```
BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
ALTER DATABASE otus SET DEFAULT_TRANSACTION_ISOLATION TO 'repeatable read';
SHOW transaction_isolation;
```
Ответ: read committed
```
insert into persons (first_name, second_name) values('sveta', 'svetova');
select * from persons;
```
id|first_name|second_name|
:----|:--------:|-----:
1  |ivan    |ivanov |
2|  petr   |petrov | 
3|  sergey   |sergeev |
4|  sveta   |svetova |

##### 10. Вторая сессия:
```
select * from persons; 
```
id|first_name|second_name|
:----|:--------:|-----:
1  |ivan    |ivanov |
2|  petr   |petrov | 
3|  sergey   |sergeev |

##### Нет новой записи! Что не так?
```
commit;
```
id|first_name|second_name|
:----|:--------:|-----:
1  |ivan    |ivanov |
2|  petr   |petrov | 
3|  sergey   |sergeev |
##### 11. Ворая сессия: 
```
select * from persons;
```
id|first_name|second_name|
:----|:--------:|-----:
1  |ivan    |ivanov |
2|  petr   |petrov | 
3|  sergey   |sergeev |
```
commit;
```
id|first_name|second_name|
:----|:--------:|-----:
1  |ivan    |ivanov |
2|  petr   |petrov | 
3|  sergey   |sergeev |
4|  sveta   |svetova |
































