# Кластер Patroni on-premise.
##### 0. Установка postgresql-14.
##### 1. Установка ETCD:
```
sudo apt update && sudo apt upgrade -y
--apt purge etcd -y
--apt purge etcd-server -y
--apt purge etcd-client -y
apt install etcd -y
systemctl stop etcd
rm -rf /var/lib/etcd/member/snap/*
rm -rf /var/lib/etcd/member/wal/*
ls -l /var/lib/
sudo chown -R etcd /var/lib/etcd
> /etc/default/etcd
vim /etc/default/etcd
```
###### Внутренние ноды на статич.адресах, доменные имена полностью:
```
vim /etc/hostname
etcd1.ru-central1.internal
etcd2.ru-central1.internal 
etcd3.ru-central1.internal 
```
```
ETCD_NAME="etcd1.ru-central1.internal"
ETCD_LISTEN_CLIENT_URLS="http://0.0.0.0:2379"
ETCD_ADVERTISE_CLIENT_URLS="http://10.128.0.20:2379"
ETCD_LISTEN_PEER_URLS="http://0.0.0.0:2380"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://10.128.0.20:2380"
ETCD_INITIAL_CLUSTER_TOKEN="PatroniCluster"
ETCD_INITIAL_CLUSTER="etcd1.ru-central1.internal=http://10.128.0.20:2380,etcd2.ru-central1.internal=http://10.128.0.16:2380,etcd3.ru-central1.internal=http://10.128.0.27:2380"
ETCD_INITIAL_CLUSTER_STATE="new"
ETCD_DATA_DIR="/var/lib/etcd"
ETCD_ELECTION_TIMEOUT="5000"
ETCD_HEARTBEAT_INTERVAL="1000"
```
```
ETCD_NAME="etcd3.ru-central1.internal"
ETCD_LISTEN_CLIENT_URLS="http://0.0.0.0:2379"
ETCD_ADVERTISE_CLIENT_URLS="http://10.128.0.27:2379"
ETCD_LISTEN_PEER_URLS="http://0.0.0.0:2380"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://10.128.0.27:2380"
ETCD_INITIAL_CLUSTER_TOKEN="PatroniCluster"
ETCD_INITIAL_CLUSTER="etcd1.ru-central1.internal=http://10.128.0.20:2380,etcd2.ru-central1.internal=http://10.128.0.16:2380,etcd3.ru-central1.internal=http://10.128.0.27:2380"
ETCD_INITIAL_CLUSTER_STATE="new"
ETCD_DATA_DIR="/var/lib/etcd"
ETCD_ELECTION_TIMEOUT="5000"
ETCD_HEARTBEAT_INTERVAL="1000"
```
```
systemctl status etcd
systemctl start etcd
systemctl is-enabled etcd
etcdctl cluster-health
etcdctl member list

sudo etcdctl member add etcd-02 http://192.168.0.42:2380
sudo etcdctl member add etcd2 http://192.168.5.163:2380

```




##### 2. Установка PATRONI

```
sudo passwd root
12345

sudo apt-get install gnupg1 gnupg2 -y
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
sudo wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
sudo apt update
sudo apt-get install postgresql-14 -y
pg_isready
systemctl status postgresql
-- systemctl start postgresql
-- systemctl stop postgresql
sudo apt-get install -y python3 python3-pip git
sudo pip3 install psycopg2-binary
systemctl stop postgresql
sudo -u postgres pg_dropcluster 14 main
sudo systemctl daemon-reload
pg_dropcluster 14 main
pg_isready
pg_lsclusters
sudo pip3 install patroni[etcd]
sudo ln -s /usr/local/bin/patroni /bin/patroni
sudo vim /etc/systemd/system/patroni.service
```
```
[Unit]
Description=High availability PostgreSQL Cluster
After=syslog.target network.target

[Service]
Type=simple
User=postgres
Group=postgres
ExecStart=/usr/local/bin/patroni /etc/patroni.yml
KillMode=process
TimeoutSec=30
Restart=no

[Install]
WantedBy=multi-user.target
```
```
sudo vim /etc/patroni.yml
```
###### Вставляем в patroni.yml свой вариант конфига. Далее бутстрапим:
```
sudo -u postgres patroni /etc/patroni.yml
```
###### Исправляем ошибку. В секции postgresql указываем путь к бинарникам: bin_dir: /usr/lib/postgresql/14/bin
###### Проверим, изменим состояние запуска patroni и стартуем его как сервис:
```
sudo systemctl is-enabled patroni
sudo systemctl enable patroni
sudo systemctl start patroni
sudo patronictl -c /etc/patroni.yml list
```
Member|Host|Role|State|Tl|Lag in MB|
:----|:--------:|-----:|-----:|-----:|-----:
pg1|192.168.5.165|Leader  |Running|1| |
pg2|192.168.5.166|Replica |Running|1|0|
pg3|192.168.5.167|Replica |Running|1|0|
```
sudo patronictl -c /etc/patroni.yml restart postgres
```
###### Если поронять: на мастере pg1:
```
systemctl stop patroni
```
###### На pg2:
```
root@pg2:/home/mgb# sudo patronictl -c /etc/patroni.yml list
+--------+---------------+---------+---------+----+-----------+
| Member | Host          | Role    | State   | TL | Lag in MB |
+ Cluster: patroni (7114613472625263394) ----+----+-----------+
| pg1    | 192.168.5.165 | Replica | stopped |    |   unknown |
| pg2    | 192.168.5.166 | Leader  | running |  3 |           |
| pg3    | 192.168.5.167 | Replica | running |  3 |         0 |
+--------+---------------+---------+---------+----+-----------+
root@pg2:/home/mgb# sudo patronictl -c /etc/patroni.yml list
+--------+---------------+---------+---------+----+-----------+
| Member | Host          | Role    | State   | TL | Lag in MB |
+ Cluster: patroni (7114613472625263394) ----+----+-----------+
| pg2    | 192.168.5.166 | Leader  | running |  3 |           |
| pg3    | 192.168.5.167 | Replica | running |  3 |         0 |
+--------+---------------+---------+---------+----+-----------+
```
#### Pg_Bouncer
```
sudo apt install -y pgbouncer
vim /etc/pgbouncer/pgbouncer.ini
```
```
[databases]
otus = host=127.0.0.1 port=5432 dbname=otus 
[pgbouncer]
logfile = /var/log/postgresql/pgbouncer.log
pidfile = /var/run/postgresql/pgbouncer.pid
listen_addr = *
listen_port = 6432
auth_type = md5
auth_file = /etc/pgbouncer/userlist.txt
admin_users = admindb
```
###### На pg3
```
sudo -u postgres psql -h localhost
create database otus;
```
###### Ответ: ОШИБКА:  в транзакции в режиме "только чтение" нельзя выполнить CREATE DATABASE
###### На pg2
```
sudo -u postgres psql -h localhost
create database otus;
```
###### На pg3
```
\l
                                  Список баз данных
    Имя    | Владелец | Кодировка | LC_COLLATE  |  LC_CTYPE   |     Права доступа
-----------+----------+-----------+-------------+-------------+-----------------------
 otus      | postgres | UTF8      | ru_RU.UTF-8 | ru_RU.UTF-8 |
 postgres  | postgres | UTF8      | ru_RU.UTF-8 | ru_RU.UTF-8 |
 template0 | postgres | UTF8      | ru_RU.UTF-8 | ru_RU.UTF-8 | =c/postgres          +
           |          |           |             |             | postgres=CTc/postgres
 template1 | postgres | UTF8      | ru_RU.UTF-8 | ru_RU.UTF-8 | =c/postgres          +
           |          |           |             |             | postgres=CTc/postgres
(4 строки)
```

































###### !!! Если поломался старый кластер
```
patronictl -c /etc/patroni.yml remove 7088634863084761990
```
