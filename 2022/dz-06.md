# Кластер Patroni on-premise.
##### 0. Установка postgresql-14.
##### 1. Установка ETCD:
```
apt install etcd -y
systemctl stop etcd
rm -rf /var/lib/etcd/*
ls -l /var/lib/
sudo chown -R etcd /var/lib/etcd
> /etc/default/etcd
vim /etc/default/etcd
```
```
ETCD_NAME="etcd1"
ETCD_LISTEN_CLIENT_URLS="http://0.0.0.0:2379"
ETCD_ADVERTISE_CLIENT_URLS="http://10.128.0.20:2379"
ETCD_LISTEN_PEER_URLS="http://0.0.0.0:2380"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://10.128.0.20:2380"
ETCD_INITIAL_CLUSTER_TOKEN="testcluster"
ETCD_INITIAL_CLUSTER="etcd1=http://10.128.0.20:2380,etcd2=http://10.128.0.16:2380,etcd3=http://10.128.0.27:2380"
ETCD_INITIAL_CLUSTER_STATE="new"
ETCD_DATA_DIR="/var/lib/etcd"
ETCD_ELECTION_TIMEOUT="5000"
ETCD_HEARTBEAT_INTERVAL="1000"
```
```
systemctl status etcd
systemctl start etcd
systemctl is-enabled etcd
etcdctl cluster-health
etcdctl member list

sudo etcdctl member add etcd-02 http://192.168.0.42:2380
sudo etcdctl member add etcd2 http://192.168.5.163:2380

```




##### 2. Установка PATRONI

```
sudo passwd root
12345

sudo apt-get install gnupg1 gnupg2 -y
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
sudo wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
sudo apt update
sudo apt-get install postgresql-14 -y
pg_isready
systemctl status postgresql
-- systemctl start postgresql
-- systemctl stop postgresql
sudo apt-get install -y python3 python3-pip git
sudo pip3 install psycopg2-binary
systemctl stop postgresql
sudo -u postgres pg_dropcluster 14 main
sudo systemctl daemon-reload
pg_dropcluster 14 main
pg_lsclusters
sudo pip3 install patroni[etcd]
sudo ln -s /usr/local/bin/patroni /bin/patroni
sudo vim /etc/systemd/system/patroni.service
```
```
[Unit]
Description=High availability PostgreSQL Cluster
After=syslog.target network.target

[Service]
Type=simple
User=postgres
Group=postgres
ExecStart=/usr/local/bin/patroni /etc/patroni.yml
KillMode=process
TimeoutSec=30
Restart=no

[Install]
WantedBy=multi-user.target
```
```
sudo vim /etc/patroni.yml
```




































