# Горизонтальное масштабирование средствами CITUS.
###### 0. Подготовка 4-х нод. 1-я будет координатором.
```
sudo apt update && apt upgrade -y -q
```
```
# Добавляем скрипт от citus data
curl https://install.citusdata.com/community/deb.sh | sudo bash
```
```
# Уст. сборку postgresql-14 c citus;
apt -y install postgresql-14-citus-10.2
```
```
# На каждой ноде preload citus extension: 
sudo pg_conftool 14 main set shared_preload_libraries citus
```
```
# Configure connection and authentication:
sudo pg_conftool 14 main set listen_addresses '*'
```
```
# На координаторе:
sudo vim /etc/postgresql/14/main/pg_hba.conf
host  all all 192.168.5.0/24            trust
host    all             all             127.0.0.1/32         trust -- только на координаторе: заменим scram-sha-256 на trust
host    all             all             0.0.0.0/0            scram-sha-256  -- только на координаторе
# На всех остальных:
host  all all 192.168.5.0/24  trust
systemctl restart postgresql
sudo update-rc.d postgresql enable
```
```
# Создадим расширение для базовой БД postgresql
sudo -i -u postgres psql -c "CREATE EXTENSION citus;"
```
```
# активируем 2 ноды на координаторе:
sudo -i -u postgres psql -c "SELECT * FROM master_add_node('citus2', 5432);"
sudo -i -u postgres psql -c "SELECT * FROM master_add_node('citus3', 5432);"
# проверим, что все подключилось:
sudo -i -u postgres psql -c "SELECT * FROM master_get_active_worker_nodes();"
```
```
 node_name | node_port
-----------+-----------
 citus3    |      5432
 citus2    |      5432
```
######  Для шардирования по ключу для таблиц создается PRIMARY KEY (id); БД на каждой ноде создаем сами.
```
# убрать ноду:
SELECT master_remove_node('citus1', 5432);
```
```
sudo -i -u postgres psql -c "show citus.shard_replication_factor;"
 citus.shard_replication_factor
--------------------------------
 1
 # 1 означает, что при падении 1 воркера все теряется, кроме координатора 
```
```
sudo -i -u postgres psql
CREATE DATABASE bank;
\c bank
CREATE TABLE test2(i int);
\dt
          Список отношений
 Схема  |  Имя  |   Тип   | Владелец
--------+-------+---------+----------
 public | test2 | таблица | postgres
 ```
###### Подвох: нет ключа шардирования, нет расширения для БД bank.
```
SELECT * FROM pg_extension;
 oid  | extname | extowner | extnamespace | extrelocatable | extversion | extconfig | extcondition
-------+---------+----------+--------------+----------------+------------+-----------+--------------
 13743 | plpgsql |       10 |           11 | f              | 1.0        |           |
# в каждой бд!
CREATE EXTENSION citus;
SELECT * FROM pg_extension;
  oid  | extname | extowner | extnamespace | extrelocatable | extversion | extconfig | extcondition
-------+---------+----------+--------------+----------------+------------+-----------+--------------
 13743 | plpgsql |       10 |           11 | f              | 1.0        |           |
 16932 | citus   |       10 |           11 | f              | 10.2-4     |           |
```
```
# На координаторе:
CREATE TABLE accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      balance DECIMAL
  );
INSERT INTO accounts (balance)
  VALUES
      (1000.50), (20000), (380), (500), (55000);
select * from accounts;

                  id                  | balance
--------------------------------------+---------
 e0bf2a19-1013-4fba-b8b7-078c62dfb009 | 1000.50
 7ef5fe55-0653-414b-b5e5-490a9958ef7b |   20000
 34914414-ae7d-4996-9f7a-098fde8a56d5 |     380
 bb990353-b93d-4897-9ca9-6424446dba6d |     500

SELECT * FROM master_get_active_worker_nodes();
 node_name | node_port
-----------+-----------
(0 строк)
# Надо подключить 2 узла citus2 и citus3
SELECT * FROM master_add_node('citus2', 5432);
 master_add_node
-----------------
               1
SELECT * FROM master_add_node('citus3', 5432);
 
 master_add_node
-----------------
               2
SELECT * FROM master_get_active_worker_nodes();
 node_name | node_port
-----------+-----------
 citus3    |      5432
 citus2    |      5432
SELECT create_distributed_table('accounts', 'id');
 create_distributed_table
 SELECT * FROM pg_dist_shard;
--------------------------
(1 строка)
```
```
# На ноде 2:
\dt
               Список отношений
 Схема  |       Имя       |   Тип   | Владелец
--------+-----------------+---------+----------
 public | accounts        | таблица | postgres
 public | accounts_102008 | таблица | postgres
 public | accounts_102010 | таблица | postgres
 public | accounts_102012 | таблица | postgres
 public | accounts_102014 | таблица | postgres
 public | accounts_102016 | таблица | postgres
 public | accounts_102018 | таблица | postgres
 public | accounts_102020 | таблица | postgres
 public | accounts_102022 | таблица | postgres
 public | accounts_102024 | таблица | postgres
 public | accounts_102026 | таблица | postgres
 public | accounts_102028 | таблица | postgres
 public | accounts_102030 | таблица | postgres
 public | accounts_102032 | таблица | postgres
 public | accounts_102034 | таблица | postgres
 public | accounts_102036 | таблица | postgres
 public | accounts_102038 | таблица | postgres
 public | test2           | таблица | postgres
(18 строк)
# На видео нет первой строчки
```
###### Добавляем еще одну ноду citus4:
```
# Правим конфиг:

# Создаем базу:

# Создаем расширение:

```

```
# На координаторе подключаем ноду citus4:
SELECT * FROM master_add_node('citus4', 5432);
SELECT * FROM master_get_active_worker_nodes();

 node_name | node_port
-----------+-----------
 citus3    |      5432
 citus4    |      5432
 citus2    |      5432
(3 строки)
```
```
# Убирать ноду, к примеру citus4:
SELECT master_remove_node('citus4', 5432);
 master_remove_node
--------------------
(1 строка)
SELECT * FROM master_get_active_worker_nodes();
 node_name | node_port
-----------+-----------
 citus3    |      5432
 citus2    |      5432
(2 строки)
````
После добавления или удаления необходим ребаланс нод:
```
# ребаланс нод:
SELECT rebalance_table_shards('accounts');
 rebalance_table_shards
------------------------

(1 строка)
```

















