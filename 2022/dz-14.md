# Горизонтальное масштабирование средствами CITUS.
###### 0. Подготовка 4-х нод. 1-я будет координатором.
```
sudo apt update && apt upgrade -y -q
```
```
# Добавляем скрипт от citus data
curl https://install.citusdata.com/community/deb.sh | sudo bash
```
```
# Уст. сборку postgresql-14 c citus;
apt -y install postgresql-14-citus-10.2
```
```
# На каждой ноде preload citus extension: 
sudo pg_conftool 14 main set shared_preload_libraries citus
```
```
# Configure connection and authentication:
sudo pg_conftool 14 main set listen_addresses '*'
```
```
# На координаторе:
sudo vim /etc/postgresql/14/main/pg_hba.conf
host  all all 192.168.5.0/24            trust
host    all             all             127.0.0.1/32         trust -- только на координаторе: заменим scram-sha-256 на trust
host    all             all             0.0.0.0/0            scram-sha-256  -- только на координаторе
# На всех остальных:
host  all all 192.168.5.0/24  trust
systemctl restart postgresql
sudo update-rc.d postgresql enable
```
```
# Создадим расширение для базовой БД postgresql
sudo -i -u postgres psql -c "CREATE EXTENSION citus;"
```
```
# активируем 2 ноды на координаторе:
sudo -i -u postgres psql -c "SELECT * FROM master_add_node('citus2', 5432);"
sudo -i -u postgres psql -c "SELECT * FROM master_add_node('citus3', 5432);"
# проверим, что все подключилось:
sudo -i -u postgres psql -c "SELECT * FROM master_get_active_worker_nodes();"
```
```
 node_name | node_port
-----------+-----------
 citus3    |      5432
 citus2    |      5432
```
######  Для шардирования по ключу для таблиц создается PRIMARY KEY (id); БД на каждой ноде создаем сами.
```
# убрать ноду:
SELECT master_remove_node('citus1', 5432);
```
```
sudo -i -u postgres psql -c "show citus.shard_replication_factor;"
 citus.shard_replication_factor
--------------------------------
 1
 # 1 означает, что при падении 1 воркера все теряется
```



















