# Горизонтальное масштабирование средствами CITUS.
###### 0. Подготовка 4-х нод. 1-я будет координатором.
```
sudo apt update && apt upgrade -y -q
```
```
# Добавляем скрипт от citus data
curl https://install.citusdata.com/community/deb.sh | sudo bash
# The repository is set up! You can now install packages.
```
```
# Уст. сборку postgresql-14 c citus;
apt -y install postgresql-14-citus-10.2
```
###### YANDEX-ноды на внутр.статич.адресах, доменные имена полностью:
```
vim /etc/hosts
10.128.0.30 citus1.ru-central1.internal citus1
10.128.0.31 citus2.ru-central1.internal citus2
10.128.0.32 citus3.ru-central1.internal citus3
10.128.0.33 citus4.ru-central1.internal citus4
```
##### 1. Настройка:
```
# 1.1 На каждой ноде preload citus extension: 
sudo pg_conftool 14 main set shared_preload_libraries citus
```
```
# 1.2 Configure connection and authentication:
sudo pg_conftool 14 main set listen_addresses '*'
```
```
# YANDEX На координаторе в конец файла:
sudo vim /etc/postgresql/14/main/pg_hba.conf
# 1. add внутр.подсеть:
host    all             all             10.128.0.0/24          trust
# 2. Вкл вход с localhost по trust:
host    all             all             127.0.0.1/32           trust
# 3. Вход из вне (так не секьюрно):
host    all             all             0.0.0.0/0              scram-sha-256
# 4. На всех нодах trust-аутентификация:
host    all             all             10.128.0.0/24            trust
systemctl restart postgresql
sudo update-rc.d postgresql enable
```

```
# PROXMOX На координаторе в конец файла:
sudo vim /etc/postgresql/14/main/pg_hba.conf
# 1. add внутр.подсеть:
host  all all 192.168.5.0/24            trust
# 2. Вкл вход с localhost по trust:
host    all             all             127.0.0.1/32         trust
# 3. Вход из вне:
host    all             all             0.0.0.0/0            scram-sha-256
# 4. На всех остальных trust-аутентификация:
host  all all 192.168.5.0/24  trust
systemctl restart postgresql
sudo update-rc.d postgresql enable
```
```
# Прверка работоспособности после изминений pg_hba.conf:
sudo -i -u postgres psql
```
```
# На каждой ноде создадим расширение для базовой БД postgresql:
sudo -i -u postgres psql -c "CREATE EXTENSION citus;"
```
```
# Активируем 2 ноды citus2 и citus3 на координаторе:
sudo -i -u postgres psql -c "SELECT * FROM master_add_node('citus2', 5432);"
# Ответ:
 master_add_node
-----------------
               1
sudo -i -u postgres psql -c "SELECT * FROM master_add_node('citus3', 5432);"
# Ответ:
 master_add_node
-----------------
               2
# Проверим, что все подключилось:
sudo -i -u postgres psql -c "SELECT * FROM master_get_active_worker_nodes();"
# Ответ: 
 node_name | node_port
-----------+-----------
 citus3    |      5432
 citus2    |      5432
``` 
```
# На каждой ноде и координаторе создадим тестовую БД bank:
sudo -i -u postgres psql
create database bank;
```
```
# На всех нодах и координаторе создадим расширение для БД bank:
\c bank
CREATE EXTENSION citus;
SELECT * FROM pg_extension;
# Ответ:
  oid  | extname | extowner | extnamespace | extrelocatable | extversion | extconfig | extcondition
-------+---------+----------+--------------+----------------+------------+-----------+--------------
 13743 | plpgsql |       10 |           11 | f              | 1.0        |           |
 16384 | citus   |       10 |           11 | f              | 10.2-4     |           |
```
######  Для шардирования по ключу для таблиц создается PRIMARY KEY (id); БД на каждой ноде создаем сами.
```
sudo -i -u postgres psql
CREATE DATABASE bank;
\c bank
CREATE TABLE test2(i int);
\dt
          Список отношений
 Схема  |  Имя  |   Тип   | Владелец
--------+-------+---------+----------
 public | test2 | таблица | postgres
 ```
###### Подвох: нет ключа шардирования, нет расширения для БД bank.
```
SELECT * FROM pg_extension;
 oid  | extname | extowner | extnamespace | extrelocatable | extversion | extconfig | extcondition
-------+---------+----------+--------------+----------------+------------+-----------+--------------
 13743 | plpgsql |       10 |           11 | f              | 1.0        |           |
# в каждой бд!
CREATE EXTENSION citus;
SELECT * FROM pg_extension;
  oid  | extname | extowner | extnamespace | extrelocatable | extversion | extconfig | extcondition
-------+---------+----------+--------------+----------------+------------+-----------+--------------
 13743 | plpgsql |       10 |           11 | f              | 1.0        |           |
 16932 | citus   |       10 |           11 | f              | 10.2-4     |           |
```
```
# На координаторе:
CREATE TABLE accounts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      balance DECIMAL
  );
INSERT INTO accounts (balance)
  VALUES
      (1000.50), (20000), (380), (500), (55000);
select * from accounts;

                  id                  | balance
--------------------------------------+---------
 e0bf2a19-1013-4fba-b8b7-078c62dfb009 | 1000.50
 7ef5fe55-0653-414b-b5e5-490a9958ef7b |   20000
 34914414-ae7d-4996-9f7a-098fde8a56d5 |     380
 bb990353-b93d-4897-9ca9-6424446dba6d |     500

SELECT * FROM master_get_active_worker_nodes();
 node_name | node_port
-----------+-----------
(0 строк)
# Надо подключить 2 узла citus2 и citus3
SELECT * FROM master_add_node('citus2', 5432);
 master_add_node
-----------------
               1
SELECT * FROM master_add_node('citus3', 5432);
 
 master_add_node
-----------------
               2
SELECT * FROM master_get_active_worker_nodes();
 node_name | node_port
-----------+-----------
 citus3    |      5432
 citus2    |      5432
SELECT create_distributed_table('accounts', 'id');
 create_distributed_table
 SELECT * FROM pg_dist_shard;
--------------------------
(1 строка)
```
```
# На ноде 2:
\dt
               Список отношений
 Схема  |       Имя       |   Тип   | Владелец
--------+-----------------+---------+----------
 public | accounts        | таблица | postgres
 public | accounts_102008 | таблица | postgres
 public | accounts_102010 | таблица | postgres
 public | accounts_102012 | таблица | postgres
 public | accounts_102014 | таблица | postgres
 public | accounts_102016 | таблица | postgres
 public | accounts_102018 | таблица | postgres
 public | accounts_102020 | таблица | postgres
 public | accounts_102022 | таблица | postgres
 public | accounts_102024 | таблица | postgres
 public | accounts_102026 | таблица | postgres
 public | accounts_102028 | таблица | postgres
 public | accounts_102030 | таблица | postgres
 public | accounts_102032 | таблица | postgres
 public | accounts_102034 | таблица | postgres
 public | accounts_102036 | таблица | postgres
 public | accounts_102038 | таблица | postgres
 public | test2           | таблица | postgres
(18 строк)
# На видео нет первой строчки
```
```
# На ноде 3:
\dt

               Список отношений
 Схема  |       Имя       |   Тип   | Владелец
--------+-----------------+---------+----------
 public | accounts_102009 | таблица | postgres
 public | accounts_102011 | таблица | postgres
 public | accounts_102013 | таблица | postgres
 public | accounts_102015 | таблица | postgres
 public | accounts_102017 | таблица | postgres
 public | accounts_102019 | таблица | postgres
 public | accounts_102021 | таблица | postgres
 public | accounts_102023 | таблица | postgres
 public | accounts_102025 | таблица | postgres
 public | accounts_102027 | таблица | postgres
 public | accounts_102029 | таблица | postgres
 public | accounts_102031 | таблица | postgres
 public | accounts_102033 | таблица | postgres
 public | accounts_102035 | таблица | postgres
 public | accounts_102037 | таблица | postgres
 public | accounts_102039 | таблица | postgres
 public | test2           | таблица | postgres
(17 строк)
```

###### Добавляем еще одну ноду citus4:
```
# Правим конфиг:

# Создаем расширение:


# Создаем базу:

# Создаем расширение:

```

```
# На координаторе подключаем ноду citus4:
SELECT * FROM master_add_node('citus4', 5432);
 master_add_node
-----------------
               4

SELECT * FROM master_get_active_worker_nodes();

 node_name | node_port
-----------+-----------
 citus3    |      5432
 citus4    |      5432
 citus2    |      5432
(3 строки)
```
```
# Проверка содержимого БД:
\c bank
\dt+
```
```
# Если убирать ноду, к примеру citus4:
SELECT master_remove_node('citus4', 5432);
 master_remove_node
--------------------
(1 строка)
SELECT * FROM master_get_active_worker_nodes();
 node_name | node_port
-----------+-----------
 citus3    |      5432
 citus2    |      5432
(2 строки)
````
###### После добавления или удаления необходим ребаланс нод:
```
# ребаланс нод на координаторе:
sudo -i -u postgres psql
\c bank
SELECT rebalance_table_shards('accounts');
 rebalance_table_shards
------------------------

(1 строка)

# После добавления citus4:
ОШИБКА:  connection to the remote node localhost:5432 failed with the following error: fe_sendauth: no password supplied

```
###### Проверка степени отказоустойчивости:
```
sudo -i -u postgres psql -c "show citus.shard_replication_factor;"
 citus.shard_replication_factor
--------------------------------
 1
 # 1 означает, что при падении 1 воркера все теряется, кроме координатора 
```

```
# убрать ноду:
SELECT master_remove_node('citus1', 5432);
```
















