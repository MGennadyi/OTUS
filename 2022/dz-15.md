# Greenplum
###### Оф.требования ubuntu-18, 20 нет.
```
cat /etc/lsb-release
# или
cat /etc/os-release
DISTRIB_ID=Ubuntu
DISTRIB_RELEASE=20.04
DISTRIB_CODENAME=focal
```
```
vim /etc/hosts
10.128.0.51 gp1.ru-central1.internal gp1
10.128.0.52 gp2.ru-central1.internal gp2
10.128.0.53 gp3.ru-central1.internal gp3
10.128.0.54 gp4.ru-central1.internal gp4
```
###### Правим репозиторий:
```
sudo vim /etc/apt/sources.list
deb http://security.ubuntu.com/ubuntu xenial-security main
deb http://ppa.launchpad.net/greenplum/db/ubuntu bionic main
deb http://ru.archive.ubuntu.com/ubuntu bionic main
```
```
sudo apt update && sudo apt upgrade -y -q
```
```
# Создаем группу, юзера, пароль:
sudo groupadd gpadmin
sudo useradd gpadmin -r -m -g gpadmin
echo gpadmin:gpadmin123 | sudo chpasswd
# или так: 
sudo passwd gpadmin
```
```
# создаем ssh ключ (без фразы)  для связывания ВМ:
sudo -u gpadmin ssh-keygen -t rsa -b 4096 -q -f /home/gpadmin/.ssh/id_rsa -N ''
# Даем пользователю gpadmin право на sudo:
sudo usermod -aG sudo gpadmin
```
###### Аристов: Установка из пакетов не сработает, т.к. на 20 ubuntu нет пакетов.
###### Создаем bash-скрипт
```
vim greenplum.sh
```
```
#! /bin/bash

# Check we are a root
if [ "$EUID" -ne 0 ]
    then echo "Please run this script as root"
    exit
fi

REPO="/etc/apt/sources.list.d/greenplum-ubuntu-db-bionic.list"
PIN="/etc/apt/preferences.d/99-greenplum"

echo "Add required repositories"
touch \$REPO
cat > \$REPO <<REPOS
deb http://ppa.launchpad.net/greenplum/db/ubuntu bionic main
deb http://ru.archive.ubuntu.com/ubuntu bionic main
REPOS

echo "Configure repositories"
touch \$PIN
cat > \$PIN <<PIN_REPO
Package: *
Pin: release v=18.04
Pin-Priority: 1
PIN_REPO

echo "Repositories described in \$REPO"
echo "Repositories configuration in \$PIN"
echo "Installing greenplum"
sudo apt update && sudo apt install greenplum-db-6 -y
```
```
vim /etc/apt/sources.list
deb http://ppa.launchpad.net/greenplum/db/ubuntu bionic main
deb http://ru.archive.ubuntu.com/ubuntu bionic main
```
```
# Добавим ключики:
gpg --keyserver keyserver.ubuntu.com --recv 3C6FDC0C01D86213
gpg --export --armor 3C6FDC0C01D86213 | sudo apt-key add -
# Права на выполнение и выполняем:
chmod +x greenplum.sh
sudo ./greenplum.sh
```
```
# Смотрим, что установилось:
dpkg-query -l
# Появился пакет: greenplum-db-6 
```
```
# выдадим права -R на каталог по умолчанию:
sudo find / -name "greenplum*"
# Нужный ответ: /opt/greenplum-db-6.21.0/greenplum_path.sh
sudo chown -R gpadmin:gpadmin /opt/greenplum*
```
```
sudo su gpadmin
$
bash
To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.
gpadmin@gp2:/home/mgb$
source /opt/greenplum-db-6.21.0/greenplum_path.sh
which gpssh
# Ответ:
/opt/greenplum-db-6.21.0/bin/gpssh
gpadmin@gp2:/home/mgb$

```
```
# Выполняем скрипт первоначальной настройки через 'source' встройка кода в bach :
vim /root/.bashrc
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
sudo -u gpadmin source /opt/greenplum-db-6.21.0/greenplum_path.sh
# Ответ: sudo: source: command not found
# Прописалась ли переменная?:
which gpssh
# Ответа не должно быть
gpadmin@gp1:vim /home/gpadmin/.bashrc
# Нужно наш sources прописать в .bashrc:
source /opt/greenplum-db-6.21.0/greenplum_path.sh
which gpssh
# Ответ: /opt/greenplum-db-6.21.0/bin/gpssh
exit

# Т.О. прописываем код в наш bash:
# По ниже команде по умолчанию попадаем не в bash, а в dash!:
root@gp:/home/mgb# sudo su gpadmin
# По этому выполняем:
$ bash
To run a command as administrator (user "root"), use "sudo <command>".
See "man sudo_root" for details.
gpadmin@gp:/home/mgb$ source /opt/greenplum-db-6.21.0/greenplum_path.sh
gpadmin@gp:/home/mgb$ which gpssh
/opt/greenplum-db-6.21.0/bin/gpssh
gpadmin@gp:/home/mgb$ which gpssh
/opt/greenplum-db-6.21.0/bin/gpssh
exit
# Что бы не dash, а bash для этого:
sudo dpkg-reconfigure dash
pass: gpadmin123
# Попадаем в окно конфига dash, отвечаем:
no
exit
# Если теперь зайти под пользователем gpadmin:
root@gp:/home/mgb# sudo su gpadmin
# Будет:
sh-5.0$
echo $shell
# Не помогло сменить dash на bash, т.к теперь идет запуск просто shell. Для bash меняем вручную:
chsh
Password: gpadmin123
# Ответ:
Changing the login shell for gpadmin
Enter the new value, or press ENTER for the default
        Login Shell [/bin/sh]: 
# Ввести:
/bin/bash
sh-5.0$
# теперь команды из-под пользователя gpadmin будут обрабатываться bash. 
# Проделаем то же самое на 2-4 ВМ, из под gpadmin:
sudo su gpadmin
# Прописываем source в bashrc:
echo "source /opt/greenplum-db-6.21.0/greenplum_path.sh" >> ~/.bashrc
# Меняем shell на bash;
chsh -s /bin/bash
pass: gpadmin123
# Проверим, что все работает:
which gpssh
# Ответ:
/opt/greenplum-db-6.21.0/bin/gpssh
```
###### По документации Прописать ssh друг у друга. Не работает:
```
apt install ssh
ssh-copy-id gp2
yes
Permission denied (publickey).
```
```
# Аристов: идем рекомендованным производителем путем, вкл. вход по паролю (потом лучше отключить):
sudo vim /etc/ssh/sshd_config
# Включ. временно вход по паролю:
sudo vim /etc/ssh/sshd_config
PasswordAuthentication no -> yes (в самом низу)
sudo systemctl restart sshd
# Проделать на остальных вм
exit
root@gp:/home/mgb# sudo su gpadmin
gpadmin@gp:/home/mgb$ sudo vim /etc/ssh/sshd_config
[sudo] password for gpadmin:
gpadmin@gp:/home/mgb$ sudo systemctl restart sshd
# C gp1 Раскладываем ключ по другим ВМ из под gpadmin:
ssh-copy-id gp2
yes
pass: gpadmin123
ssh-copy-id gp3
ssh-copy-id gp4
# C gp2 Раскладываем ключ по другим ВМ:
ssh-copy-id gp1
ssh-copy-id gp3
ssh-copy-id gp4
# C gp3 Раскладываем ключ по другим ВМ:
ssh-copy-id gp1
ssh-copy-id gp2
ssh-copy-id gp4
# C gp4 Раскладываем ключ по другим ВМ:
ssh-copy-id gp1
ssh-copy-id gp2
ssh-copy-id gp3
```
```
# На каждой ноде прописываем: 
Если в домашнем каталоге gpadmin, то: ~/hostfile_exkeys иначе:
vim home/gpadmin/hostfile_exkeys
gp1
gp2
gp3
gp4
# Убеждаемся, что каждая нода видит других через утилиту:
gpssh-exkeys -f hostfile_exkeys
```
```
# Подтвердить установку ssh:
gpssh -f hostfile_exkeys -e 'ls -l /opt/greenplum-db-6.21.0'
```
###### Создать каталоги, где будут лежать наши данные 'Data Storage Areas':
```
sudo mkdir -p /data/master
sudo chown gpadmin:gpadmin /data/master
```
```
# На ноде 2:
sudo mkdir -p /data/master
sudo chown gpadmin:gpadmin /data/master
# На ноде 3-4, отличаются доп.созданием /mirror:
sudo mkdir -p /data/primary
sudo mkdir -p /data/mirror
sudo chown -R gpadmin /data/*
```
###### Валидировать нашу установку
###### На всех хостах  инициалицация:
```
# Создаем конфиг с сегментами:
vim ~/hostfile_gpinitsystem
gp3
gp4
```
###### Инициализация:
```
# При инициализации системы указать, где второй мастер
vim /home/gpadmin/gpconfigs/gpinitsystem_config
# Задаем:
# Кто у нас мастер:
MASTER_HOSTNAME=gp1
# Каталог, где лежат данные:
MASTER_DIRECTORY=/data/master
# отключим мирроринг-?
MIRROR_PORT_BASE=7000

```
```
gpadmin@gp1: mkdir /home/gpadmin/gpconfigs
cp $GPHOME/docs/cli_help/gpconfigs/gpinitsystem_config \
     /home/gpadmin/gpconfigs/gpinitsystem_config
```
###### Кол-во хостов должно быть больше кол-ва сегментов
```




```
```
# После рестарта всех нод, на мастер-ноде:
gpstart
# Прописать 
nano ~/.bashrc
MASTER_DATA_DIRECTORY=/opt/data/master/gpseg-1
export MASTER_DATA_DIRECTORY
```
psql -d postgres
\l
# Зальем данные:
cd $HOME && wget --quiet https://edu.postgrespro.ru/demo_small.zip && unzip demo_small.zip && psql -d postgres < demo_small.sql
\l+
# смотрим схему bookings, которая не включена в путь?
\dt+ bookings.*
```
