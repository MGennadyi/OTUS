# Настройка autovacuum для достижения максимального уровня производительности

В качестве инструмента измерения производительности кластера используется pgbench, доступного в PostgreSQL. Позволяет протестировать различные комбинации числа клиентов и заданий.

1. Создать GCE инстанс типа e2-medium и standard disk 10GB

2. Установить на него PostgreSQL 13 с дефолтными настройками

3. Применить параметры настройки PostgreSQL из прикрепленного к материалам занятия файла:

Параметры железа:
RAM = 4 GB;
CPUs = 1;
Data Storage = balanced persisten disk=10GB;

Параметры postgresql.conf:
``` 
sudo vim /etc/postgresql/12/main/postgresql.conf
```
```
max_connections = 40

shared_buffers = 1GB

effective_cache_size = 3GB

maintenance_work_mem = 512MB

checkpoint_completion_target = 0.9

wal_buffers = 16MB

default_statistics_target = 500

random_page_cost = 4

effective_io_concurrency = 2

work_mem = 6553kB

min_wal_size = 4GB

max_wal_size = 16GB
```
```
sudo systemctl restart postgresql
```

6. Предварительная подготовка: создание и наполнение таблиц для теста: pgbench с ключом -i (инициализация), с ключем -s (маштабирование) в bash из-под postgres:
```
pgbench -i -s 1 -U postgres postgres
```

8. Запуск теста: 
```
pgbench -c 8 -j 1 -P 10 -T 300 -U postgres postgres
```
Ответ:
Базовыми настройками:
tpc = 342
Настройки ДЗ:
tpc = 347
Добавлены настройки autovacuum:
tpc = 348


10. Настрока autovacuum максимально эффективно:
```
log_autovacuum_min_duration - время выполнения автоочистки в мс, при
превышении которого информация об этом действии записывается в жу По
умолчанию стоит -1, что отключает журналирование действий автоочистки. При
нулевом значении в журнале фиксируются все действия автоочистки. 

autovacuum_max_workers  - максимальное число процессов автоочистки
(не   считая   процесса   autovacuum_launcher),   которые   могут   выполняться
одновременно. По умолчанию 3. 

autovacuum_naptime  - минимальная задержка в секундах между двумя
запусками автоочистки. Если это значение задаётся без единиц измерения, оно
считается заданным в секундах. По умолчанию задержка равна 1min. 
Другие параметры влияют на то, как часто будет автоакуум заходить в
таблицы для очистки. 

autovacuum_vacuum_threshold = 50

autovacuum_vacuum_scale_factor = 0.2

vacuum_cost_page_hit = 1
vacuum_cost_page_miss = 10
vacuum_cost_page_dirty = 20
vacuum_cost_limit = 200
autovacuum_vacuum_cost_delay = 20ms #200ms
autovacuum_vacuum_cost_limit = -1 #100
vacuum_cost_page_hit = 6

мягко перезагрузить: 
sudo pg_ctlcluster 14 main reload


autovacuum_max_workers = 1 # = кол-во CPU/2
shared_buffers = 128MB #=0.25 ОЗУ

```
```
systemctl restart postgresql
pgbench -c 8 -j 1 -P 10 -T 600 -U postgres postgres
```
