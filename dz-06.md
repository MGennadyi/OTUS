# Настройка autovacuum для достижения максимального уровня производительности

В качестве инструмента измерения производительности кластера используется pgbench, доступного в PostgreSQL. pgbench позволяет протестировать различные комбинации числа клиентов и заданий.

1. Создать GCE инстанс типа e2-medium и standard disk 10GB

2. Установить на него PostgreSQL 13 с дефолтными настройками

3. Применить параметры настройки PostgreSQL из прикрепленного к материалам занятия файла:

Параметры железа:
RAM = 4 GB;
CPUs = 2;
Data Storage = balanced persisten disk = 10GB;

Забегая вперед, скажу, что настройки, предложенные преподавателем отличаются от тех, которые показывает калькулятор PGTUNE. Однако с настройками PGTUNE, где min_wal_size = 2GB 
max_wal_size = 4GB maintenance_work_mem = 256MB *pgbench* показал TPC более низкое значение. 

Применим параметры в postgresql.conf:
``` 
sudo vim /etc/postgresql/13/main/postgresql.conf
```
```
max_connections = 40

shared_buffers = 1GB

effective_cache_size = 3GB

maintenance_work_mem = 512MB

checkpoint_completion_target = 0.9

wal_buffers = 16MB

default_statistics_target = 500

random_page_cost = 4

effective_io_concurrency = 2

work_mem = 6553kB

min_wal_size = 4GB

max_wal_size = 16GB
```
```
sudo systemctl restart postgresql
```

4. Предв.подготовка: создание и заполнение таблиц для теста: pgbench с ключом -i (инициализация), -s (маштабирование) -F (фактор заполнения)-U (user); БД testpgbench:
```
create database testpgbench;
pgbench -h 192.168.5.180 -p 5432 -U postgres -i -s 10 testpgbench
pgbench -i -s 10 -F 80 -U postgres testpgbench
```

5. Запуск теста: -j (потоки); -c (сеансов к БД); -T (время сек);  
```
\set r random_zipfian(0, 100000000, 1.07)
BEGIN;
pgbench -c 8 -j 2 -P 10 -T 300 -U postgres testpgbench
```
Ответ:
Базовыми настройками:
tpc = 342

6. Настрока autovacuum максимально эффективно:
```
autovacuum_vacuum_cost_delay = 0         # Отключить вакуум на основе стоимости
autovacuum_vacuum_cost_limit = 10000     # Максимальное значение
autovacuum_vacuum_threshold = 50         # Значение по умолчанию
autovacuum_vacuum_scale_factor = 0.5     # Значение по умолчанию
log_autovacuum_min_duration = 0
autovacuum_max_workers = 6
autovacuum_naptime = 20
```
Различные комбинации от вышеуказанных параметров приводили к снижению производительности. Так например autovacuum_vacuum_scale_factor = 0.1 показал tpc = 345.
```
systemctl restart postgresql
su postgres
pgbench -c 8 -j 1 -P 10 -T 300 -U postgres postgres
```
Ответ:
tpc = 347. Это максимальное значение, которое мне удалось получить.

При подготовке ДЗ использовал материал https://qastack.ru/dba/21068/aggressive-autovacuum-on-postgresql
