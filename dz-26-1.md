 # Разворачивание High Availability PostgreSQL-HA от bitnami в связке repmgr+pgpool.
1. Подготовка: установка Google cloud SDK и Kubectl
```
sudo apt-get install apt-transport-https ca-certificates gnupg
echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
sudo apt-get update && sudo apt-get install google-cloud-sdk
```
Разворачиваем через web-интерфейс: goole console/navigation menu/Kubernetes engine/clusters/create. Все по дефолту, кроме имени=postgresha
При этом изначально gcloud не имеет доступ к кластеру GKE. Для этого проинициализируем:
```
gcloud container clusters get-credentials postgresha --zone us-central1-c
```
где: 
postgresha - имя GKE;
--zone us-central1-c зона расположения GKE;

Ответ:

WARNING: Could not open the configuration file: [/root/.config/gcloud/configurations/config_default].

ERROR: (gcloud.container.clusters.get-credentials) You do not currently have an active account selected.

Please run:

  $ gcloud auth login

If you have already logged in with a different account:

    $ gcloud config set account ACCOUNT
```
$ gcloud auth login
```
Ответ:

Go to the following link in your browser: ...
Enter verification code: ...

You are now logged in as [ser_stiven@mail.ru].
Your current project is [None].  You can change this setting by running:
  $ gcloud config set project PROJECT_ID
```
gcloud container clusters list
```

Ответ:

NAME        LOCATION       MASTER_VERSION   MASTER_IP      MACHINE_TYPE  NODE_VERSION     NUM_NODES  STATUS

postgresha  us-central1-c  1.21.6-gke.1500  35.224.169.15  e2-medium     1.21.6-gke.1500  3          RUNNING

2. Установка HELM:
2.1 Подготовка:
```
curl https://baltocdn.com/helm/signing.asc | sudo apt-key add -
sudo apt-get install apt-transport-https --yes
echo "deb https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
sudo apt-get update
sudo apt-get install helm
```
2.2 Добавить репозиторий helm:
```
helm repo add bitnami https://charts.bitnami.com/bitnami
```
Ответ:

"bitnami" has been added to your repositories

Разорачивание кластера по умолчанию в 1 команду:
```
helm install pgsql-ha bitnami/postgresql-ha
```
Ответ:

Error: INSTALLATION FAILED: Kubernetes cluster unreachable: Get "http://localhost:8080/version": dial tcp [::1]:8080: connect: connection refused


прописать для kebectl нужный credentials
```
gcloud container clusters get-credentials postgresha --zone us-central1-c
```
```
kubectl get nodes
```
Ответ:

 gke-postgresha-default-pool-fce57f88-3sv1   Ready    <none>   5h38m   v1.21.6-gke.1500

 gke-postgresha-default-pool-fce57f88-82p2   Ready    <none>   5h47m   v1.21.6-gke.1500

 gke-postgresha-default-pool-fce57f88-vjz6   Ready    <none>   5h41m   v1.21.6-gke.1500
  ```
 kubectl cluster-info
 ```
Kubernetes control plane is running at https://35.224.169.15

 GLBCDefaultBackend is running at https://35.224.169.15/api/v1/namespaces/kube-system/services/default-http-backend:http/proxy

 KubeDNS is running at https://35.224.169.15/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
 Metrics-server is running at https://35.224.169.15/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy






















