 # Разворачивание High Availability PostgreSQL-HA от bitnami в связке repmgr+pgpool.
1. Подготовка: установка Google cloud SDK и Kubectl
```
sudo apt-get install apt-transport-https ca-certificates gnupg
echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
sudo apt-get update && sudo apt-get install google-cloud-sdk
```
Разворачиваем через web-интерфейс: goole console/navigation menu/Kubernetes engine/clusters/create. Все по дефолту, кроме имени=postgresha. Для изменения параметров идем: NODE POOLS.


Ответ:

WARNING: Could not open the configuration file: [/root/.config/gcloud/configurations/config_default].

ERROR: (gcloud.container.clusters.get-credentials) You do not currently have an active account selected.

Please run:

  $ gcloud auth login

If you have already logged in with a different account:

    $ gcloud config set account ACCOUNT
```
$ gcloud auth login
```
Ответ:

Go to the following link in your browser: ...
Enter verification code: ...

You are now logged in as [ser_stiven@mail.ru].
Your current project is [None].  You can change this setting by running:
  $ gcloud config set project PROJECT_ID
```
gcloud container clusters list
```

Ответ:

NAME        LOCATION       MASTER_VERSION   MASTER_IP      MACHINE_TYPE  NODE_VERSION     NUM_NODES  STATUS

postgresha  us-central1-c  1.21.6-gke.1500  35.224.169.15  e2-medium     1.21.6-gke.1500  3          RUNNING

Изначально gcloud не имеет доступ к кластеру GKE. Для этого проинициализируем для того что бы прописать для kebectl нужный credentials:
```
gcloud container clusters get-credentials postgresha --zone us-central1-c
```


2. Установка HELM:
```
curl https://baltocdn.com/helm/signing.asc | sudo apt-key add -
sudo apt-get install apt-transport-https --yes
echo "deb https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
sudo apt-get update
sudo apt-get install helm
```
Добавить репозиторий helm:
```
helm repo add bitnami https://charts.bitnami.com/bitnami
```
Ответ:

"bitnami" has been added to your repositories

Разорачивание кластера по умолчанию в 1 команду:
```
helm install pgsql-ha bitnami/postgresql-ha
```
Ответ:

Error: INSTALLATION FAILED: Kubernetes cluster unreachable: Get "http://localhost:8080/version": dial tcp [::1]:8080: connect: connection refused


```
kubectl get nodes
```
Ответ:

 gke-postgresha-default-pool-fce57f88-3sv1   Ready    <none>   5h38m   v1.21.6-gke.1500

 gke-postgresha-default-pool-fce57f88-82p2   Ready    <none>   5h47m   v1.21.6-gke.1500

 gke-postgresha-default-pool-fce57f88-vjz6   Ready    <none>   5h41m   v1.21.6-gke.1500
  ```
 kubectl cluster-info
 ```
Ответ:
 
 Kubernetes control plane is running at https://35.224.169.15
 ```
 kubectl get componentstatuses
 ```
 Ответ:
 
 Warning: v1 ComponentStatus is deprecated in v1.19+
 
NAME                 STATUS    MESSAGE             ERROR
 
controller-manager   Healthy   ok
 
scheduler            Healthy   ok
 
etcd-0               Healthy   {"health":"true"}
 
etcd-1               Healthy   {"health":"true"}
 
 Достаем пароль для подключение:
 ```
 export POSTGRES_PASSWORD=$(kubectl get secret --namespace default pgsql-ha-postgresql-ha-postgresql -o jsonpath="{.data.postgresql-password}" | base64 --decode)

echo $POSTGRES_PASSWORD
 ```
 Ответ:
 
 wa5aGV1jgs
 
###### Прокидываем порт на локальную машину:
 ```
kubectl port-forward --namespace default svc/pgsql-ha-postgresql-ha-pgpool 5432:5432
 ```
###### Ответ error, т.к. работает локально postgres
 ```
kubectl port-forward --namespace default svc/pgsql-ha-postgresql-ha-pgpool 5433:5432
 ```
Ответ:
 
Forwarding from 127.0.0.1:5433 -> 5432
Forwarding from [::1]:5433 -> 5432
 
 Запускаем другой сеанс вм и работаем от туда. Порт из GKE прокинут на локальную вм. Можем подключиться с паролем:
 
 ```
 PGPASSWORD=$POSTGRES_PASSWORD psql -h 127.0.0.1 -p 5433 -U postgres -d postgres
 ```
  Вводим пароль:
 ```
 wa5aGV1jgs
```
Получаем приглашение:  postgres=# 
 ```
 \l
 ```
 ######
 Убьем мастер:
 ```
root@pg-03:/home/mgb# kubectl delete pod/pgsql-ha-postgresql-ha-postgresql-0
 ```
 Ответ:
 
 pod "pgsql-ha-postgresql-ha-postgresql-0" deleted
```
 \l
 ```
 Ничего не поменялось, все живое. А если зайти на подик?
 ```
 kubectl exec -it pod/pgsql-ha-postgresql-ha-postgresql-0 -- bash
```
 Ответ:
 
 I have no name!@pgsql-ha-postgresql-ha-postgresql-0:/$
 ```
 /opt/bitnami/scripts/postgresql-repmgr/entrypoint.sh repmgr -f /opt/bitnami/repmgr/conf/repmgr.conf cluster  show
```
 postgresql-repmgr 16:17:49.51
 
postgresql-repmgr 16:17:49.52 Welcome to the Bitnami postgresql-repmgr container
 
postgresql-repmgr 16:17:49.52 Subscribe to project updates by watching https://github.com/bitnami/bitnami-docker-postgresql-repmgr
 
postgresql-repmgr 16:17:49.52 Submit issues and feature requests at https://github.com/bitnami/bitnami-docker-postgresql-repmgr/issues
 
postgresql-repmgr 16:17:49.52
 

 ID   | Name                                | Role    | Status    | Upstream                            | Location | Priority | Timeline | Connection string                                                                                 
------+-------------------------------------+---------+-----------+-------------------------------------+----------+----------+----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

 1000 | pgsql-ha-postgresql-ha-postgresql-0 | standby |   running | pgsql-ha-postgresql-ha-postgresql-1 | default  | 100      | 2        | user=repmgr password=6b3CTcpPHV host=pgsql-ha-postgresql-ha-postgresql-0.pgsql-ha-postgresql-ha-postgresql-headless.default.svc.cluster.local dbname=repmgr port=5432 connect_timeout=5

 1001 | pgsql-ha-postgresql-ha-postgresql-1 | primary | * running |                                     | default  | 100      | 2        | user=repmgr password=6b3CTcpPHV host=pgsql-ha-postgresql-ha-postgresql-1.pgsql-ha-postgresql-ha-postgresql-headless.default.svc.cluster.local dbname=repmgr port=5432 connect_timeout=5

 

 
 
 
 
 

 

 

 





















